<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IELTS Listening Test 1 – Section 1</title>

  <!-- 使用 premium test1 题库 -->
  <script src="questions.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 760px;
      margin: 0 auto;
      padding: 24px;
      line-height: 1.6;
    }

    h1 {
      text-align: center;
      font-size: 26px;
      margin-bottom: 16px;
    }

    .preview-box {
      text-align: center;
      margin-bottom: 16px;
      color: #b00000;
      font-weight: bold;
    }
    .preview-box p {
      margin: 4px 0;
    }

    .audio-wrapper {
      position: relative;
      margin: 8px 0 24px;
    }
    .audio-wrapper audio {
      width: 100%;
    }
    .audio-overlay {
      position: absolute;
      inset: 0;
      z-index: 2;
      background: transparent;
      cursor: not-allowed;
    }

    .inst-block {
      background: #f7f7f7;
      border-left: 4px solid #333;
      padding: 16px;
      margin: 16px 0 20px;
    }
    .inst-block strong {
      display: block;
      margin-bottom: 4px;
    }

    .question {
      margin-top: 18px;
      font-weight: bold;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      font-size: 15px;
      box-sizing: border-box;
    }

    .options {
      margin-top: 6px;
      margin-left: 4px;
    }
    .options label {
      display: block;
      font-weight: normal;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <h1>SECTION 1</h1>

  <div class="preview-box">
    <p>You now have some time to look at Questions 1–10.</p>
    <p id="countdownText">
      The recording will begin in <span id="countNum">10</span> seconds.
    </p>
  </div>

  <div class="audio-wrapper">
    <audio
      id="audioPlayer"
      src="/public/audio/premium/test1/Listening_Test_1_SECTION_1.mp3"
      controls
    ></audio>
    <div id="audioOverlay" class="audio-overlay"></div>
  </div>

  <div class="inst-block">
    <strong>Questions 1–6</strong>
    Write <strong>NO MORE THAN TWO WORDS AND/OR A NUMBER</strong> for each answer.
  </div>

  <form id="testForm"></form>

  <template id="inst7to10">
    <div class="inst-block">
      <strong>Questions 7–10</strong>
      Choose the correct letter <strong>A, B or C.</strong>
    </div>
  </template>

  <script>
    // ============= attemptId + localStorage helpers =============
    function getAttemptId() {
      const params = new URLSearchParams(location.search);
      let id = (params.get("attemptId") || "").trim();
      if (!id) id = (localStorage.getItem("attemptId") || "").trim();
      if (!id) id = (localStorage.getItem("attempt_id") || "").trim();
      return id;
    }

    const attemptId = getAttemptId();
    if (attemptId) {
      localStorage.setItem("attemptId", attemptId);
      localStorage.setItem("attempt_id", attemptId);
    }

    function collectSectionAnswers(from, to) {
      const out = {};
      for (let n = from; n <= to; n++) {
        const textEl = document.getElementById(`q${n}`);
        if (textEl) {
          out[n] = (textEl.value || "").trim();
          continue;
        }
        const chosen = document.querySelector(`input[name="q${n}"]:checked`);
        out[n] = (chosen?.value || "").trim();
      }
      return out;
    }

    function mergeIntoLocalAnswers(sectionAnswers) {
      if (!attemptId) return;
      const key = `answers_${attemptId}`;
      let base = {};
      try { base = JSON.parse(localStorage.getItem(key) || "{}"); } catch { base = {}; }
      const merged = { ...base, ...sectionAnswers };
      localStorage.setItem(key, JSON.stringify(merged));
    }

    // ============= 加载 Section 1 题库 =============
    const sectionData = window.PREMIUM_TEST1 && window.PREMIUM_TEST1.section1;

    if (!sectionData || !sectionData.questions) {
      document.body.innerHTML = "<h1>Section 1</h1><p>Question data not found.</p>";
      throw new Error("No section1 data");
    }

    const form = document.getElementById("testForm");
    const inst7to10Tpl = document.getElementById("inst7to10").content;

    sectionData.questions.forEach((q) => {
      if (q.number === 7) {
        form.appendChild(inst7to10Tpl.cloneNode(true));
      }

      const wrapper = document.createElement("div");

      const qTitle = document.createElement("div");
      qTitle.className = "question";
      qTitle.textContent = `${q.number}. ${q.question}`;
      wrapper.appendChild(qTitle);

      if (q.type === "blank") {
        const input = document.createElement("input");
        input.type = "text";
        input.id = `q${q.number}`;
        wrapper.appendChild(input);
      }

      if (q.type === "mcq") {
        const optBox = document.createElement("div");
        optBox.className = "options";

        q.options.forEach((opt, idx) => {
          const label = document.createElement("label");
          const radio = document.createElement("input");
          radio.type = "radio";
          radio.name = `q${q.number}`;
          radio.value = opt;

          const letter = String.fromCharCode(65 + idx);
          label.appendChild(radio);
          label.insertAdjacentText("beforeend", ` ${letter}. ${opt}`);
          optBox.appendChild(label);
        });

        wrapper.appendChild(optBox);
      }

      form.appendChild(wrapper);
    });

    // ============= 倒计时 + 自动播放逻辑 =============
    const PREVIEW_SECONDS = 10;
    const countdownSpan = document.getElementById("countNum");
    const countdownText = document.getElementById("countdownText");

    const audio = document.getElementById("audioPlayer");
    const overlay = document.getElementById("audioOverlay");

    let hasStarted = false;
    let lastTime = 0;

    function tryStartPlayback(fromUser) {
      if (hasStarted) return;
      const playPromise = audio.play();

      if (playPromise && playPromise.then) {
        playPromise
          .then(() => {
            hasStarted = true;
            countdownText.textContent = "The recording is now playing.";
          })
          .catch(() => {
            if (!fromUser) {
              countdownText.textContent = "The recording is ready. Click the play button to start.";
            }
          });
      } else {
        hasStarted = true;
        countdownText.textContent = "The recording is now playing.";
      }
    }

    function startCountdown() {
      let remaining = PREVIEW_SECONDS;
      countdownSpan.textContent = remaining;

      const timer = setInterval(() => {
        remaining -= 1;

        if (remaining <= 0) {
          clearInterval(timer);
          countdownText.textContent = "The recording is now starting.";
          tryStartPlayback(false);
        } else {
          countdownSpan.textContent = remaining;
        }
      }, 1000);
    }

    overlay.addEventListener("click", () => {
      if (!hasStarted) tryStartPlayback(true);
    });

    audio.addEventListener("timeupdate", () => {
      lastTime = audio.currentTime;
    });

    audio.addEventListener("seeking", () => {
      if (Math.abs(audio.currentTime - lastTime) > 1) {
        audio.currentTime = lastTime;
      }
    });

    audio.addEventListener("pause", () => {
      if (!audio.ended && hasStarted) {
        audio.play().catch(() => {});
      }
    });

    // ✅ 音频结束 → 保存本页 1-10 → 跳转 Section2（带 attemptId）
    audio.addEventListener("ended", () => {
      if (!attemptId) {
        alert("缺少 attemptId，请从 start.html 入口重新进入。");
        return;
      }
      const s1 = collectSectionAnswers(1, 10);
      mergeIntoLocalAnswers(s1);
      window.location.href = "./section2.html?attemptId=" + encodeURIComponent(attemptId);
    });

    window.addEventListener("load", startCountdown);
  </script>
</body>
</html>
