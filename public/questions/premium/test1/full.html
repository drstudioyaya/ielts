<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>IELTS Premium Listening Test 1 (Full 40 Questions)</title>

<!-- ✅ 载入题库（按你提供的 questions.js 原样使用，不改题目与答案） -->
<script src="questions.js"></script>

<style>
  body { font-family: Arial, sans-serif; max-width: 860px; margin: auto; padding: 22px; line-height: 1.6; }
  h1 { text-align: center; font-weight: 800; margin: 8px 0 18px; }
  .inst-block { background: #f7f7f7; border-left: 4px solid #111; padding: 14px 16px; margin: 16px 0; }
  .inst-title { font-size: 16px; font-weight: 800; margin-bottom: 6px; }
  .section { margin-top: 26px; padding-top: 8px; border-top: 2px solid #eee; }
  .section h2 { margin: 10px 0 8px; font-size: 20px; }
  .audio-box { margin: 10px 0 14px; }
  .question { margin-top: 14px; font-weight: 800; }
  input[type="text"] { width: 100%; padding: 8px 10px; margin-top: 6px; font-size: 15px; box-sizing: border-box; }
  .options { margin-left: 18px; margin-top: 6px; }
  .options label { display: block; margin: 6px 0; }
  .submit-btn { width: 100%; background: #000; color: #fff; padding: 13px; margin-top: 22px; font-size: 18px; cursor: pointer; border: none; border-radius: 0; }
  .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
  #result { display: none; margin-top: 18px; padding: 16px; border: 2px solid #eee; background: #fafafa; font-size: 16px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }
  .small { color: #666; font-size: 13px; margin-top: 6px; }
  .err { color: #b00020; font-weight: 700; }

  /* Map */
  .map-wrap { margin: 10px 0 6px; }
  .map-img { max-width: 100%; border: 1px solid #ddd; display: none; }
  .map-fallback { display: none; }
</style>
</head>

<body>

<h1>IELTS Premium Listening Test 1 — Full Test (40 Questions)</h1>

<div class="inst-block">
  <div class="inst-title">Instructions</div>
  <p>You will hear each recording <strong>once only</strong>. Answer the questions as instructed.</p>
  <p class="small">
    Marking follows IELTS-style rules:
    case-insensitive; extra leading/trailing punctuation ignored; currency symbols ignored;
    and strict word/format limits are enforced (answers that exceed the stated word limits receive <strong>0</strong>).
  </p>
</div>

<!-- 可选：联系方式（不会影响做题；你要收集就留着） -->
<div class="inst-block">
  <div class="inst-title">Optional contact (for follow-up)</div>
  <div class="grid-2">
    <div>
      <label class="small">Name</label>
      <input id="name" type="text" placeholder="Your name (optional)" />
    </div>
    <div>
      <label class="small">WeChat</label>
      <input id="wechat" type="text" placeholder="WeChat ID (optional)" />
    </div>
  </div>
  <div style="margin-top:10px;">
    <label class="small">Email</label>
    <input id="email" type="text" placeholder="Email (optional)" />
  </div>
  <div style="margin-top:10px;">
    <label>
      <input id="consent" type="checkbox" />
      I agree to receive study tips and updates.
    </label>
  </div>
</div>

<form id="fullForm"></form>

<button id="submitBtn" class="submit-btn" type="button">Submit Full Test (40 Questions)</button>

<div id="result"></div>

<script>
(function () {
  const resultEl = document.getElementById("result");
  const submitBtn = document.getElementById("submitBtn");

  function showError(msg) {
    resultEl.style.display = "block";
    resultEl.innerHTML = `<div class="err">${msg}</div>`;
  }

  const test = window.PREMIUM_TEST1;
  if (!test || !test.section1 || !test.section2 || !test.section3 || !test.section4) {
    showError("Error: Question bank not loaded. Make sure questions.js is in the same folder as full.html.");
    return;
  }

  // ✅ 必须存在：normalizeAnswer + isCorrectAnswer（来自 questions.js）
  if (typeof window.normalizeAnswer !== "function" || typeof window.isCorrectAnswer !== "function") {
    showError("Error: scoring helpers missing. Ensure questions.js defines normalizeAnswer() and isCorrectAnswer().");
    return;
  }

  // ✅ 兼容：如果你的 questions.js 没定义 wordCount，而 isCorrectAnswer 内部会用到
  if (typeof window.wordCount !== "function") {
    window.wordCount = function (text) {
      const t = window.normalizeAnswer(text);
      if (!t) return 0;
      return t.split(" ").filter(Boolean).length;
    };
  }

  const SECTIONS = [
    { key: "section1", title: "Section 1", qRangeText: "Questions 1–10" },
    { key: "section2", title: "Section 2", qRangeText: "Questions 11–20" },
    { key: "section3", title: "Section 3", qRangeText: "Questions 21–30" },
    { key: "section4", title: "Section 4", qRangeText: "Questions 31–40" }
  ];

  const form = document.getElementById("fullForm");

  function isAllSingleLetters(list) {
    return Array.isArray(list) && list.length > 0 && list.every(a => /^[a-f]$/i.test((a ?? "").toString().trim()));
  }

  // ✅ 规则：优先用 questions.js 的 limits；若答案是字母（地图/配对题），强制单字母
  function getRule(sectionData, q) {
    const accepted = sectionData.answers?.[q.number] || [];
    const maxWordsFromLimits = sectionData.limits?.[q.number];

    const rule = {
      accepted,
      maxWords: (typeof maxWordsFromLimits === "number" ? maxWordsFromLimits : null),
      mustBeSingleLetter: false
    };

    // 11–14/24–26 这类题（答案为字母）强制单字母输入
    if (isAllSingleLetters(accepted)) {
      rule.mustBeSingleLetter = true;
      rule.maxWords = 1;
    }

    return rule;
  }

  function sectionBucketByQnum(n) {
    if (n <= 10) return "1";
    if (n <= 20) return "2";
    if (n <= 30) return "3";
    return "4";
  }

  // -----------------------------
  // Map image loader (Section 2)
  // -----------------------------
  function injectSection2Map(secDiv) {
    const wrap = document.createElement("div");
    wrap.className = "map-wrap";
    wrap.innerHTML = `
      <div class="small"><strong>Map (Questions 11–14)</strong></div>
      <img id="s2map" class="map-img" alt="Section 2 Map" />
      <div id="s2mapFallback" class="small map-fallback">
        (Map image not found. Put the map image in the same folder as full.html and name it one of:
        <code>section2-map.png</code>, <code>section2-map.jpg</code>, <code>map.png</code>, <code>map.jpg</code>)
      </div>
    `;
    secDiv.appendChild(wrap);

    const img = wrap.querySelector("#s2map");
    const fallback = wrap.querySelector("#s2mapFallback");

    const candidates = [
      "./section2-map.png",
      "./section2-map.jpg",
      "./section2_map.png",
      "./section2_map.jpg",
      "./map.png",
      "./map.jpg"
    ];

    let idx = 0;
    function tryNext() {
      if (idx >= candidates.length) {
        fallback.style.display = "block";
        return;
      }
      img.src = candidates[idx++];
    }

    img.onload = () => { img.style.display = "block"; };
    img.onerror = () => { tryNext(); };
    tryNext();
  }

  // -----------------------------
  // Render sections + questions
  // -----------------------------
  function render() {
    SECTIONS.forEach(({ key, title, qRangeText }) => {
      const sec = test[key];
      const secDiv = document.createElement("div");
      secDiv.className = "section";
      secDiv.dataset.sectionKey = key;

      secDiv.innerHTML = `
        <h2>${title} — ${qRangeText}</h2>
        <div class="audio-box">
          <audio controls style="width:100%" src="${sec.audio}"></audio>
        </div>
      `;

      const inst = document.createElement("div");
      inst.className = "inst-block";

      if (key === "section1") {
        inst.innerHTML = `
          <div class="inst-title">SECTION 1 Instructions</div>
          <p>Questions 1–6: <strong>Write NO MORE THAN TWO WORDS AND/OR A NUMBER</strong> for each answer.</p>
          <p>Questions 7–10: <strong>Choose the correct letter A, B or C.</strong></p>
        `;
      } else if (key === "section2") {
        inst.innerHTML = `
          <div class="inst-title">SECTION 2 Instructions</div>
          <p>Questions 11–14: <strong>Choose the correct letter A–F.</strong></p>
          <p>Questions 15–16: <strong>Write NO MORE THAN ONE WORD AND/OR A NUMBER</strong> for each answer.</p>
          <p>Questions 17–20: <strong>Choose the correct letter A, B or C.</strong></p>
        `;
      } else if (key === "section3") {
        inst.innerHTML = `
          <div class="inst-title">SECTION 3 Instructions</div>
          <p>Questions 21–23: <strong>Choose the correct letter A, B or C.</strong></p>
          <p>Questions 24–26: <strong>Choose the correct letter A–D.</strong></p>
          <p>Questions 27–30: <strong>Write NO MORE THAN ONE WORD AND/OR A NUMBER</strong> for each answer.</p>
        `;
      } else {
        inst.innerHTML = `
          <div class="inst-title">SECTION 4 Instructions</div>
          <p>Questions 31–40: <strong>Write NO MORE THAN ONE WORD AND/OR A NUMBER</strong> for each answer.</p>
        `;
      }
      secDiv.appendChild(inst);

      if (key === "section2") injectSection2Map(secDiv);

      sec.questions.forEach(q => {
        const rule = getRule(sec, q);

        const block = document.createElement("div");
        block.dataset.qnum = String(q.number);

        let html = `<div class="question">${q.number}. ${q.question}</div>`;

        if (q.type === "blank") {
          const placeholder = rule.mustBeSingleLetter ? "Enter a single letter (e.g., B)" : "";
          html += `<input type="text" id="q${q.number}" placeholder="${placeholder}" />`;
          // ✅ 不输出 Max words 提示（保持你要求）
        }

        if (q.type === "mcq") {
          html += `<div class="options">`;
          q.options.forEach((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);

            // ✅ 关键：radio value 使用“选项文字”，然后把 q.options 传给 isCorrectAnswer 做字母映射
            html += `
              <label>
                <input type="radio" name="q${q.number}" value="${opt}" />
                ${letter}. ${opt}
              </label>
            `;
          });
          html += `</div>`;
        }

        block.innerHTML = html;
        secDiv.appendChild(block);
      });

      form.appendChild(secDiv);
    });
  }

  render();

  // -----------------------------
  // Submit: score all 40, create 1 attempt, redirect to score.html
  // -----------------------------
  async function submitFullAttempt() {
    submitBtn.disabled = true;

    const answers = {};
    const perSection = {
      "1": { rawCorrect: 0, rawTotal: 10 },
      "2": { rawCorrect: 0, rawTotal: 10 },
      "3": { rawCorrect: 0, rawTotal: 10 },
      "4": { rawCorrect: 0, rawTotal: 10 }
    };

    let correct = 0;
    const total = 40;

    SECTIONS.forEach(({ key }) => {
      const sec = test[key];

      sec.questions.forEach(q => {
        let user = "";

        if (q.type === "blank") {
          user = document.getElementById(`q${q.number}`)?.value || "";
        } else if (q.type === "mcq") {
          const chosen = document.querySelector(`input[name="q${q.number}"]:checked`);
          if (chosen) user = chosen.value || "";
        }

        answers[q.number] = user;

        const rule = getRule(sec, q);

        // ✅ 单字母题：必须是 A-F（或 A-D）这种单字母，否则直接错
        if (rule.mustBeSingleLetter) {
          const u = window.normalizeAnswer(user);
          if (!/^[a-f]$/i.test(u)) return;
        }

        // ✅ 关键：统一用 questions.js 的 isCorrectAnswer（带 maxWords + MCQ options）
        const ok = window.isCorrectAnswer(user, rule.accepted, rule.maxWords, q.options);

        if (ok) {
          correct += 1;
          const bucket = sectionBucketByQnum(Number(q.number));
          perSection[bucket].rawCorrect += 1;
        }
      });
    });

    answers._meta = { perSection };

    resultEl.style.display = "block";
    resultEl.innerHTML = `<strong>Submitting...</strong><div class="small">Local score: ${correct} / ${total}</div>`;

    try {
      const payload = {
        testId: "premium-test1",
        section: "full",
        scoreLocal: correct,
        answers,
        contact: {
          name: document.querySelector("#name")?.value || "",
          wechat: document.querySelector("#wechat")?.value || "",
          email: document.querySelector("#email")?.value || "",
          consentMarketing: !!document.querySelector("#consent")?.checked
        }
      };

      const r = await fetch("/api/attempts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || `API error (${r.status})`);

      const attemptId = data.attemptId;
      console.log({ attemptId });

      location.href = `./score.html?attemptId=${encodeURIComponent(attemptId)}`;
    } catch (err) {
      console.error(err);
      resultEl.innerHTML =
        `<div class="err">Submit failed: ${String(err.message || err)}</div>
         <div class="small">Local score preserved: ${correct} / ${total}</div>`;
      submitBtn.disabled = false;
    }
  }

  submitBtn.addEventListener("click", submitFullAttempt);
})();
</script>

</body>
</html>
