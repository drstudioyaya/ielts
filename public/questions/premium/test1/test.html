<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>IELTS Premium Listening Test</title>

<!-- 载入题库 -->
<script src="questions.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 760px;
        margin: auto;
        padding: 25px;
        line-height: 1.6;
    }

    h1 {
        text-align: center;
        font-weight: bold;
        margin-bottom: 20px;
    }

    .inst-block {
        background: #f7f7f7;
        border-left: 4px solid #333;
        padding: 18px;
        margin: 20px 0;
    }

    .inst-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .question {
        margin-top: 18px;
        font-weight: bold;
    }

    input[type="text"] {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        font-size: 15px;
    }

    .options {
        margin-left: 20px;
        margin-top: 6px;
    }

    .submit-btn {
        width: 100%;
        background: black;
        color: white;
        padding: 12px;
        margin-top: 25px;
        font-size: 18px;
        cursor: pointer;
        border: none;
    }

    #result {
        display: none;
        margin-top: 35px;
        padding: 20px;
        border: 2px solid #eee;
        background: #fafafa;
        font-size: 18px;
        text-align: center;
    }
</style>
</head>

<body>

<h1 id="pageTitle"></h1>

<div id="sectionIntro"></div>

<div class="audio-box">
    <audio id="audioPlayer" controls style="width:100%"></audio>
</div>

<form id="testForm"></form>

<button class="submit-btn" type="button" onclick="submitAnswers()">Submit Answers</button>

<div id="result"></div>

<script>
/* -----------------------
   获取 URL 中的 section 参数
-------------------------- */
const params = new URLSearchParams(window.location.search);
const sec = params.get("section") || "1";

document.getElementById("pageTitle").innerText =
    `IELTS Listening Test 1 – Section ${sec}`;

/* -----------------------
   获取题库数据
-------------------------- */
const test = window.PREMIUM_TEST1;
const sectionData = test && test[`section${sec}`];

/* -----------------------
   若 section 没内容 → Coming Soon
-------------------------- */
if (!sectionData || !sectionData.questions || sectionData.questions.length === 0) {
    document.body.innerHTML = `
        <h1>Section ${sec}</h1>
        <div class="inst-block">
            <p><strong>This section is coming soon.</strong></p>
        </div>
    `;
    throw new Error("Section empty");
}

/* -----------------------
   写入音频路径
-------------------------- */
document.getElementById("audioPlayer").src = sectionData.audio;

/* -----------------------
   顶部说明（按 section 简单显示范围）
-------------------------- */
const rangeMap = { "1": "1–10", "2": "11–20", "3": "21–30", "4": "31–40" };
const qRange = rangeMap[String(sec)] || "";
document.getElementById("sectionIntro").innerHTML = `
    <div class="inst-block">
        <div class="inst-title">SECTION ${sec}${qRange ? ` — Questions ${qRange}` : ""}</div>
        <p>You will hear a recording. Answer the questions as instructed.</p>
        <p>You will hear the recording <strong>once only</strong>.</p>
    </div>
`;

/* -----------------------
   Questions 1–6 指令（只在 Section 1 显示）
-------------------------- */
if (sec === "1") {
    document.getElementById("testForm").innerHTML += `
        <div class="inst-block">
            <div class="inst-title">Questions 1–6</div>
            <p><strong>Write NO MORE THAN TWO WORDS AND/OR A NUMBER for each answer.</strong></p>
        </div>
    `;
}

/* -----------------------
   渲染全部题目
-------------------------- */
const form = document.getElementById("testForm");

sectionData.questions.forEach((q) => {

    /* 插入 Questions 7–10 指令（保持你原逻辑） */
    if (q.number === 7) {
        form.innerHTML += `
            <div class="inst-block">
                <div class="inst-title">Questions 7–10</div>
                <p><strong>Choose the correct letter A, B or C.</strong></p>
            </div>
        `;
    }

    let html = `<div class="question">${q.number}. ${q.question}</div>`;

    if (q.type === "blank") {
        html += `<input type="text" id="q${q.number}" />`;
    }

    if (q.type === "mcq") {
        html += `<div class="options">`;
        q.options.forEach((opt, index) => {
            const letterLower = String.fromCharCode(97 + index); // a/b/c
            html += `
                <label>
                    <input type="radio"
                           name="q${q.number}"
                           value="${opt}"
                           data-letter="${letterLower}" />
                    ${String.fromCharCode(65 + index)}. ${opt}
                </label><br>
            `;
        });
        html += `</div>`;
    }

    form.innerHTML += html;
});

/* -----------------------
   高级评分函数（容错）
-------------------------- */
function normalize(text) {
    if (text === undefined || text === null) return "";
    return text
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[\$]/g, "")
        .replace(/(\d+)(th|st|nd|rd)/g, "$1")
        .replace(/\s+/g, " ");
}

/* -----------------------
   本地判分：支持多答案；MCQ 支持“字母答案”或“文本答案”
-------------------------- */
function isCorrectLocal(q, userText, userLetterLower) {
    const accepted = (sectionData.answers && sectionData.answers[q.number]) || [];
    const acceptedArr = Array.isArray(accepted) ? accepted : [accepted];

    const acceptedNorm = acceptedArr.map(normalize).filter(Boolean);
    if (acceptedNorm.length === 0) return false;

    // 如果答案看起来全是单个字母（a/b/c/d/e/f...），就用字母对比
    const looksLikeLetters = acceptedNorm.every(a => /^[a-f]$/.test(a));
    if (looksLikeLetters) {
        return acceptedNorm.includes(normalize(userLetterLower));
    }

    // 否则用文本对比（Section1 的 mcq/blank）
    const userN = normalize(userText);
    return acceptedNorm.includes(userN);
}

/* -----------------------
   提交评分
-------------------------- */
function submitAnswers() {
  let score = 0;
  const answers = {}; // 题号 -> 用户输入（用于入库）

  sectionData.questions.forEach((q) => {
    let user = "";
    let userLetterLower = "";

    if (q.type === "blank") {
      user = document.getElementById(`q${q.number}`)?.value || "";
    }

    if (q.type === "mcq") {
      const chosen = document.querySelector(`input[name="q${q.number}"]:checked`);
      if (chosen) {
        user = chosen.value || "";
        userLetterLower = chosen.dataset.letter || "";
      }
    }

    answers[q.number] = user;

    if (isCorrectLocal(q, user, userLetterLower)) score++;
  });

  // ✅ 发到 API，拿 attemptId，然后跳转评分页
  fetch("/api/attempts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      testId: "premium-test1",
      section: sec,
      scoreLocal: score,
      answers: answers,
      contact: {
        name: document.querySelector("#name")?.value || "",
        wechat: document.querySelector("#wechat")?.value || "",
        email: document.querySelector("#email")?.value || "",
        consentMarketing: !!document.querySelector("#consent")?.checked
      }
    })
  })
    .then((r) => r.json())
    .then((data) => {
      const attemptId = data && data.attemptId;
      if (!attemptId) throw new Error("No attemptId returned from /api/attempts");
      location.href = `./score.html?attemptId=${encodeURIComponent(attemptId)}`;
    })
    .catch((err) => {
      console.error(err);
      document.getElementById("result").style.display = "block";
      document.getElementById("result").innerHTML =
        `<strong>Your Score: ${score} / ${sectionData.questions.length}</strong><br><br>
         (API error, showing local score) Thank you for completing Section ${sec}.`;
    });
}
</script>

</body>
</html>
